<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Training Directory - {{ app_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="bg-white border-b shadow-sm">
        <div class="max-w-6xl mx-auto px-4 py-6 flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">AI Training Directory</h1>
                <p class="text-gray-600 mt-1">OpenClaw + AI workflow videos organized automatically.</p>
            </div>
            <a href="/" class="text-blue-600 hover:text-blue-700 font-medium">‚Üê Back to VideoMind</a>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-8">
        <section class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-semibold text-gray-900">Jobs Health</h2>
                <div class="flex items-center gap-2">
                    <button id="refreshJobs" class="text-xs bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">Refresh</button>
                    <button id="retryFailed" class="text-xs bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">Retry failed (10)</button>
                </div>
            </div>
            <div id="jobsCounts" class="grid grid-cols-2 md:grid-cols-6 gap-2 text-sm"></div>
            <div id="jobsFailures" class="mt-3 text-xs text-gray-700 whitespace-pre-line"></div>
        </section>

        <section class="bg-white rounded-lg shadow p-4 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-2">Batch ingest via VideoMind pipeline</h2>
            <p class="text-sm text-gray-600 mb-3">Paste YouTube URLs (one per line). We‚Äôll process transcripts + summaries and auto-publish to this directory.</p>
            <div class="grid md:grid-cols-4 gap-3 mb-3">
                <input id="batchEmail" class="border rounded px-3 py-2 md:col-span-2" placeholder="results email" />
                <select id="batchTier" class="border rounded px-3 py-2">
                    <option value="basic">basic</option>
                    <option value="detailed">detailed</option>
                    <option value="bulk">bulk</option>
                </select>
                <button id="batchBtn" class="bg-green-600 text-white rounded px-4 py-2 hover:bg-green-700">Queue Batch</button>
            </div>
            <textarea id="batchUrls" rows="5" class="border rounded w-full px-3 py-2" placeholder="https://www.youtube.com/watch?v=...\nhttps://www.youtube.com/watch?v=..."></textarea>
            <p id="batchResult" class="text-sm text-gray-700 mt-2"></p>
        </section>

        <div class="bg-white rounded-lg shadow p-4 mb-3 grid md:grid-cols-6 gap-3">
            <input id="q" class="border rounded px-3 py-2 md:col-span-2" placeholder="Search title, tools, summary..." />
            <select id="category" class="border rounded px-3 py-2">
                <option value="">All Categories</option>
                <option>Setup & Onboarding</option>
                <option>Automation Workflows</option>
                <option>Tooling & Integrations</option>
                <option>Business Use Cases</option>
                <option>Debugging & Fixes</option>
                <option>Prompts & Templates</option>
            </select>
            <select id="difficulty" class="border rounded px-3 py-2">
                <option value="">All Difficulties</option>
                <option>Beginner</option>
                <option>Intermediate</option>
                <option>Advanced</option>
            </select>
            <input id="minSignal" type="number" min="1" max="100" class="border rounded px-3 py-2" placeholder="Min signal" />
            <button id="searchBtn" class="bg-blue-600 text-white rounded px-4 py-2 hover:bg-blue-700">Filter</button>
        </div>

        <div class="flex flex-wrap items-center gap-2 mb-4">
            <button class="quickFilter text-xs bg-gray-200 px-3 py-1 rounded" data-difficulty="Beginner">Beginner only</button>
            <button class="quickFilter text-xs bg-gray-200 px-3 py-1 rounded" data-min-signal="90">90+ signal</button>
            <button class="quickFilter text-xs bg-gray-200 px-3 py-1 rounded" data-category="Business Use Cases">Business Use Cases</button>
            <button id="clearFilters" class="text-xs bg-gray-900 text-white px-3 py-1 rounded">Clear</button>
        </div>

        <div class="flex items-center justify-between mb-4">
            <p id="countText" class="text-gray-600">Loading...</p>
            <button id="seedBtn" class="text-sm bg-gray-900 text-white px-3 py-2 rounded hover:bg-black">Seed starter entries</button>
        </div>

        <div id="cards" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </main>

    <script>
        const cardsEl = document.getElementById('cards');
        const countText = document.getElementById('countText');

        async function loadJobsHealth() {
            const countsEl = document.getElementById('jobsCounts');
            const failuresEl = document.getElementById('jobsFailures');
            const res = await fetch('/api/jobs/health');
            const data = await res.json();
            const c = data.counts || {};

            const labels = ['pending','downloading','transcribing','enhancing','completed','failed'];
            countsEl.innerHTML = labels.map(k => `
                <div class="border rounded p-2 bg-gray-50">
                    <div class="text-gray-500 uppercase text-[10px]">${k}</div>
                    <div class="font-semibold text-gray-900">${c[k] ?? 0}</div>
                </div>
            `).join('');

            const failed = data.latest_failed || [];
            failuresEl.textContent = failed.length
              ? 'Recent failed jobs:\n' + failed.map(f => `‚Ä¢ ${f.youtube_url} (${(f.error_message || 'no error').slice(0,80)})`).join('\n')
              : 'No recent failures üéâ';
        }

        async function loadEntries() {
            const q = document.getElementById('q').value.trim();
            const category = document.getElementById('category').value;
            const difficulty = document.getElementById('difficulty').value;
            const minSignal = document.getElementById('minSignal').value;

            const params = new URLSearchParams();
            if (q) params.set('q', q);
            if (category) params.set('category', category);
            if (difficulty) params.set('difficulty', difficulty);
            if (minSignal) params.set('min_signal', minSignal);

            const res = await fetch(`/api/directory?${params.toString()}`);
            const data = await res.json();

            countText.textContent = `${data.count} entries`;
            cardsEl.innerHTML = (data.items || []).map(item => `
                <article class="bg-white rounded-lg border p-4 shadow-sm">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">${item.category_primary}</span>
                        <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">${item.difficulty}</span>
                    </div>
                    <h3 class="font-semibold text-gray-900 mb-2 line-clamp-2">${item.title}</h3>
                    <p class="text-sm text-gray-600 mb-2">Creator: ${item.creator_name || 'Unknown'}</p>
                    <p class="text-sm text-gray-700 whitespace-pre-line mb-3">${item.summary_5_bullets || ''}</p>
                    <p class="text-xs text-gray-600 mb-2"><b>Teaches agent:</b> ${item.teaches_agent_to || 'N/A'}</p>
                    <details class="mb-3">
                      <summary class="text-xs text-gray-700 cursor-pointer">Agent training script</summary>
                      <pre class="mt-2 text-xs bg-gray-50 border rounded p-2 whitespace-pre-wrap">${item.agent_training_script || ''}</pre>
                    </details>
                    <div class="flex items-center justify-between gap-2">
                        <span class="text-xs text-gray-500">Signal ${item.signal_score || 0}/100</span>
                        <div class="flex items-center gap-2">
                          <button class="copyPromptBtn text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300" data-prompt="${encodeURIComponent(item.prompt_template || '')}">Copy Prompt</button>
                          <a href="${item.video_url}" target="_blank" class="text-blue-600 hover:text-blue-700 text-sm font-medium">Watch ‚Üí</a>
                        </div>
                    </div>
                </article>
            `).join('') || `<div class="col-span-full bg-white border rounded p-6 text-center text-gray-600">No entries yet. Click <b>Seed starter entries</b> to load your first 3 videos.</div>`;

            document.querySelectorAll('.copyPromptBtn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const prompt = decodeURIComponent(btn.getAttribute('data-prompt') || '');
                    await navigator.clipboard.writeText(prompt);
                    btn.textContent = 'Copied!';
                    setTimeout(() => btn.textContent = 'Copy Prompt', 1200);
                });
            });
        }

        document.getElementById('searchBtn').addEventListener('click', loadEntries);
        document.getElementById('refreshJobs').addEventListener('click', loadJobsHealth);
        document.getElementById('retryFailed').addEventListener('click', async () => {
            const res = await fetch('/api/jobs/retry-failed?limit=10', { method: 'POST' });
            const data = await res.json();
            alert(`Retried ${data.retried || 0} failed jobs`);
            loadJobsHealth();
        });

        document.querySelectorAll('.quickFilter').forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.dataset.category) document.getElementById('category').value = btn.dataset.category;
                if (btn.dataset.difficulty) document.getElementById('difficulty').value = btn.dataset.difficulty;
                if (btn.dataset.minSignal) document.getElementById('minSignal').value = btn.dataset.minSignal;
                loadEntries();
            });
        });

        document.getElementById('clearFilters').addEventListener('click', () => {
            document.getElementById('q').value = '';
            document.getElementById('category').value = '';
            document.getElementById('difficulty').value = '';
            document.getElementById('minSignal').value = '';
            loadEntries();
        });

        document.getElementById('seedBtn').addEventListener('click', async () => {
            const res = await fetch('/api/directory/seed', { method: 'POST' });
            const data = await res.json();
            alert(`Seeded ${data.created} entries`);
            loadEntries();
        });

        document.getElementById('batchBtn').addEventListener('click', async () => {
            const urls = document.getElementById('batchUrls').value
                .split('\n')
                .map(s => s.trim())
                .filter(Boolean);
            const email = document.getElementById('batchEmail').value.trim();
            const tier = document.getElementById('batchTier').value;
            const resultEl = document.getElementById('batchResult');

            if (!email || urls.length === 0) {
                resultEl.textContent = 'Add email + at least one URL.';
                return;
            }

            resultEl.textContent = 'Queueing...';
            const res = await fetch('/api/process/batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ youtube_urls: urls, email, tier })
            });

            const data = await res.json();
            if (!res.ok) {
                resultEl.textContent = `Failed: ${data.detail || 'unknown error'}`;
                return;
            }

            const createdLines = (data.created || []).slice(0, 8).map(i => `‚Ä¢ queued: ${i.title || i.youtube_url}`).join('\n');
            const skippedLines = (data.skipped || []).slice(0, 8).map(i => `‚Ä¢ skipped: ${i.youtube_url} (${i.reason})`).join('\n');
            resultEl.textContent = `Queued ${data.created_count} videos. Skipped ${data.skipped_count}.\n${createdLines}${createdLines && skippedLines ? '\n' : ''}${skippedLines}`;
            loadEntries();
            loadJobsHealth();
        });

        loadEntries();
        loadJobsHealth();
    </script>
</body>
</html>
